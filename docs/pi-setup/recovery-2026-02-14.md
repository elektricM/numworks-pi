# Pi Recovery Guide — 2026-02-14

## What happened

Removing `netplan.io` via `apt remove --purge` cascaded and removed `network-manager`, `rpd-wayland-core`, and other critical packages. This killed WiFi and the Wayland desktop. **Never use `apt remove netplan.io`** — it has hard dependencies on NM and the desktop meta-packages.

## State before the breakage

### System
- Raspberry Pi OS Trixie (fresh flash from ~2026-02-12)
- Kernel: 6.12.62+rpt-rpi-v7 (32-bit armhf)
- labwc 0.9.2, pixman renderer
- Boot time: ~34s (target was ~24s)

### What was working
- drm-spifb v1.2 display driver (single-chunk SPI, 51 FPS)
- nwinput keyboard daemon on /dev/ttyS0
- Camera: OV9281 detected and preview working
- Text scaling: 1.5x via GDK_DPI_SCALE
- PackageKit masked

### /boot/firmware/config.txt (known good)
```
# (stock Trixie defaults above)

[all]
enable_uart=1

# NumWorks SPI display
dtparam=spi=on
dtoverlay=numworks-spifb,vwidth=640,vheight=480

# Camera (OV9281 requires manual overlay, not auto_detect)
camera_auto_detect=0
dtoverlay=ov9281
```

### /boot/firmware/cmdline.txt (known good)
```
console=tty1 root=PARTUUID=fd6ce822-02 rootfstype=ext4 fsck.repair=yes rootwait quiet splash plymouth.ignore-serial-consoles cfg80211.ieee80211_regdom=FR
```
Note: PARTUUID will differ on a new flash.

### WiFi config
- SSID: LOGGER
- PSK hash: 97c71b6ea716bf828bfd6c6f83ccd824313e4ac4035cae9ef05383d473c648b8
- After setup, create native NM keyfile at `/etc/NetworkManager/system-connections/wifi-LOGGER.nmconnection`:
```ini
[connection]
id=wifi-LOGGER
type=wifi
autoconnect=true

[ipv4]
method=auto

[ipv6]
method=ignore

[wifi]
ssid=LOGGER
mode=infrastructure

[wifi-security]
key-mgmt=wpa-psk
psk=97c71b6ea716bf828bfd6c6f83ccd824313e4ac4035cae9ef05383d473c648b8

[proxy]
```
Then `sudo chmod 600` the file.

### Services that were masked
```bash
sudo systemctl mask packagekit.service
sudo systemctl mask serial-getty@ttyS0.service
# The following were masked but need testing on fresh image:
sudo systemctl mask ModemManager.service
sudo systemctl mask cups.service cups-browsed.service
sudo systemctl mask bluetooth.service
sudo systemctl mask e2scrub_reap.service
sudo systemctl mask udisks2.service
sudo systemctl mask cloud-init.service cloud-init-local.service cloud-config.service cloud-final.service cloud-init-network.service
```

### labwc environment (~/.config/labwc/environment)
Already in repo at `pi-linux/config/labwc-environment`. Contains:
- `WLR_RENDER_DRM_DEVICE=/dev/dri/renderD128`
- `GSK_RENDERER=cairo`

### System labwc environment (/etc/xdg/labwc/environment)
```
WLR_RENDERER=pixman
```

### Driver deployment
```bash
cd ~/drm-spifb
make -C /lib/modules/$(uname -r)/build M=$(pwd) modules
sudo cp drm-spifb.ko /lib/modules/$(uname -r)/extra/
sudo depmod -a
```

## Recovery steps for fresh Trixie image

1. Flash Raspberry Pi OS Trixie (32-bit) to SD card
2. Boot, connect WiFi via GUI or raspi-config
3. Clone repo: `git clone https://github.com/elektricM/numworks-pi.git`
4. Run setup: `sudo bash ~/numworks-pi/pi-linux/scripts/setup.sh`
5. Add camera overlay to config.txt:
   ```
   camera_auto_detect=0
   dtoverlay=ov9281
   ```
6. Mask extra services:
   ```bash
   sudo systemctl mask packagekit.service ModemManager.service cups.service cups-browsed.service bluetooth.service e2scrub_reap.service udisks2.service
   sudo systemctl mask cloud-init.service cloud-init-local.service cloud-config.service cloud-final.service cloud-init-network.service
   ```
7. Reboot
8. Verify: `glxgears` should show ~51 FPS, camera with `rpicam-hello -t 0`

## What NOT to do
- **NEVER `apt remove netplan.io`** — cascades to remove network-manager and desktop
- Safe alternative: just delete netplan configs and mask the service:
  ```bash
  sudo rm -f /etc/netplan/*.yaml
  sudo systemctl mask netplan-ovs-cleanup.service
  ```
- Always `apt install --dry-run` before removing system packages
